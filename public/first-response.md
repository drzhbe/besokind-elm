# Первый ответ firebase

Все, что будет описани дальше, мне в итоге не пригодилось, несмотря на то, что все заработало, я успел возрадоваться решению и приобретенному опыту.

Но на следующее утро я решил попробовать кое-что попроще. Сейчас я использую просто запрос к rest api firebase на старте и отображаю карточки. В итоге на мобилке список рисуется за 2 секунды, а авторизация происходит в районе 10-15 секунд.

## Приключение с nginx + lua + redis

Установка websocket соединения в firebase-web-sdk происходит очень долго. С чем это связано, я пока не понял. Но с момента загрузки сайта до первой отдачи данных firebase'ом проходит около 10 секунд на телефоне.

Чтобы побыстрее показать список дел на главной, я подумал на бесплатном heroku развернуть nginx сервер, на котором из lua я буду периодически забирать данные с firebase и класть в redis. А уже на клиенте конечного приложения буду сразу забирать данные из heroku, а когда firebase установит websocket соединение, уже пользоваться им.

Для этого ставил (openresty buildpack)[https://github.com/geoffleyland/heroku-buildpack-openresty]. Openresty это веб-сервер nginx и набор модулей для работы с nginx на языке lua.

Как указано в репозитории билдпака, я использую (шаблон)[https://github.com/geoffleyland/heroku-buildpack-openresty-template].
1. В шаблоне я добавил в nginx.conf директиву `resolver 8.8.8.8;` чтобы можно было делать запросы в интернет. Я делаю запросы к своей базе данных firebase.
2. В `.rockspec` я добавил 2 зависимости:
```
dependencies =
{
  "luasocket", -- используется socket.url, чтобы распарсить REDIS_URL. Это константа, с урлом вида redis://name:password@host:port. А lua-resty-redis не умеет кушать такой урл. Ему надо отдельно сделать connect и отдельно auth.
  "luasec" -- используется для https get запроса к firebase, потому что обычные curl'ы к http rest api firebase'а таймаутятся
}
```

http://besokind-c.herokuapp.com/api/v0/get_data
