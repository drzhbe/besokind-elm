# Чаты

## Как хранить разговор на клиенте?

Слово Dialogue становится неуместно как только мы добавляем групповые чаты. Поэтому будем использовать слово `Room`.
`Room` используется на двух экранах:
- Список разговоров
- Разговор

`Room` хранит:
- `id`
- `users` позволяет отобразить участников чата и дать доступ к чату только его участникам
- `messages`

Чтобы отображать экран списка разговоров, нужно иметь по последнему сообщению в каждом чате.

`Message` хранит:
- `id`
- `authorId`
- `time`
- `text`

Чтобы отобразить сообщение, нам нужно иметь загруженных пользователей, чтобы отобразить их имя и аватар.

В базе данных Room хранится в двух полях:
- `room-messages`, в которой по Room.id можно достать сообщения чата
- `room-metadata`, в которой по Room.id можно достать участников чата

Поэтому чтобы отобразить чаты на экране списка разговоров нужно запросить для каждого чата:
- метаданные
- последнее сообщение

А когда придут метаданные, нужно еще запросить пользователей — участников чата.

Итого, в нашей модели есть поля:
- rooms
- users

## Существующие чатики

Веб-интерфейс чата выглядит так, что строка ввода внизу экрана, и в истории последнее сообщение — внизу. Чтобы смотреть более старые сообщения нужно скролить вверх, т.е. добавлятся ноды будут сверху.
Телеграм при выборе чата открывает разговор с одним последним сообщением и крутит прелоадер и дозагружает следующую пачку и поставляет их сверху.



# Скрол

Т.к. у нас новые записи будут добавляться сверху (вначале), то нам нужно делать prepend:
https://jsfiddle.net/zLtpL95d/1

В elm перерисовывается весь список в случае, если в модель добавляются элементы перед теми, которые уже там были:
https://ellie-app.com/33rnPjTwpcVa1/2

Сейчас я на каждое обновление кадра (requestAnimationFrame) смотрю, не увеличилась ли высота скрола у элемента. И когда она увеличилась, я выставляю флаг, а подписка на обновление кадров пока остается. И в следующий раз, когда высота не изменится, а флаг стоит — я понимаю, что все дети добавились и можно проскролить на "старое значение скрола (scrollTop) плюс новая добавленная высота (scrollHeight - lastScrollHeight)". Видно, как интерфейс дергается.

И также есть команда "подписаться на скрол после того, как у элемента будет столько-то детей".
