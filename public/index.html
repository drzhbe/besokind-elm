<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>besokind</title>
<style>
  body {
    margin: 0;
    font-family: -apple-system,BlinkMacSystemFont,Ubuntu,Roboto,Open Sans,Helvetica Neue,Helvetica,Arial,sans-serif;
    font-size: 14px;
    line-height: 16px;
  }
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  a {
    text-decoration: none;
    color: inherit;
  }
  a:hover {
    text-decoration: underline;
  }
  .light-btn {
    color: #555;
    text-decoration: none;
    cursor: pointer;
  }
  .light-btn:hover {
    text-decoration: underline;
  }
  .card-input::-webkit-input-placeholder { color: #333; }
  .card-input::-moz-placeholder { color: #333; }
  .card-input:focus::-webkit-input-placeholder { color: #ddd; }
  .card-input:focus::-moz-placeholder { color: #ddd; }
  /*#topbar {
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
  }*/
    /*.topbar__user-photo {
      float: right;
    }*/
    .topbar__login-btn {
      height: 38px;
      float: right;
    }
  /*#container {
    padding: 60px 14px 15px;
  }*/
    ._assigned {
      background: #f9f9f9;
    }
</style>

<div id="main"></div>

<script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
<script src='date-fns-distance.js'></script>
<script src="app.js"></script>
<script>
  var config = {
    apiKey: "AIzaSyBenkychYMdGWfGBnjpxDAeEzR9hu60_f0",
    authDomain: "besokind-b837c.firebaseapp.com",
    databaseURL: "https://besokind-b837c.firebaseio.com",
    storageBucket: "besokind-b837c.appspot.com",
    messagingSenderId: "490319737092"
  };
  firebase.initializeApp(config);

  var auth = firebase.auth();
  var database = firebase.database();
  var dbCards = database.ref('cards');
  dbCards.off();

  var subscribedToNewCards = false;


  function addCardToList(card) {
    card = card.val();
    card.creationTimeFriendly = dateFnsDistanceInWords(card.creationTime);
    app.ports.addCardToList.send(card);
  }


  /*
    depends on `dateFnsDistanceInWords`
  */
  function getCards(callback) {
    // todo не работает такая фильтрация
    // .orderByChild('assignedTo').equalTo('')
    dbCards.limitToLast(12).once('value', function(snapshot) {
      var cards = [];
      snapshot.forEach(function(card) {
        var card = card.val();
        card.creationTimeFriendly = dateFnsDistanceInWords(card.creationTime);
        cards.push(card);
      });
      console.log('cards', typeof cards, cards);
      app.ports.showCards.send(cards);

      if (!subscribedToNewCards) {
        subscribedToNewCards = true;
        dbCards.limitToLast(12).on('child_added', addCardToList);
      }
    }).catch(function(error) {
      console.error('error', typeof error, error);
    });
  }


  auth.onAuthStateChanged(function(user) {
    if (user) {
      database.ref('users/' + user.uid).once('value', function(snapshot) {
        var userInDb = snapshot.val();
        if (userInDb) {
          app.ports.authStateChanged.send(userInDb);
        } else {
          // authorized for the first time -> create user
          var updates = {};
          var newUser = {
            uid: user.uid,
            name: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            karma: 0,
            moderator: false
          };
          updates['users/' + user.uid] = newUser;

          database.ref()
            .update(updates)
            .then(function() {
              app.ports.authStateChanged.send(newUser);
            })
            .catch(function(error) {
              console.error('## error during [creating new user]:', error);
            });
        }
      }).catch(function(error) {
        console.error('## error during [getting user info]:', error);
      });
    } else {
      app.ports.authStateChanged.send({
        uid: '',
        name: '',
        email: '',
        photoURL: '',
        karma: 0,
        moderator: false
      });
    }
  });



  var app = Elm.Main.fullscreen();
  app.ports.login.subscribe(function(authType) {
    switch (authType) {
      case 'google':
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        break;
    }
  });

  app.ports.logout.subscribe(function() {
    auth.signOut();
  });

  app.ports.fetchStreamCards.subscribe(getCards);

  app.ports.fetchCard.subscribe(function(id) {
    database.ref('cards/' + id).once('value', function(card) {
      card = card.val();
      card.creationTimeFriendly = dateFnsDistanceInWords(card.creationTime);
      app.ports.cardFetched.send(card);
    });
  });

  /*
    port fetchCardVolunteers : String -> Cmd msg
  */
  app.ports.fetchCardVolunteers.subscribe(function(id) {
    database.ref('card-volunteers/' + id).once('value', function(snapshot) {
      var volunteers = [];
      snapshot.forEach(function(user) {
        volunteers.push(user.val());
      });
      app.ports.cardVolunteersFetched.send(volunteers);
    });
  });

  app.ports.fetchUserCards.subscribe(function(id) {
    dbCards.orderByChild('authorId').equalTo(id).once('value', function(snapshot) {
      var cards = [];
      snapshot.forEach(function(card) {
        card = card.val();
        card.creationTimeFriendly = dateFnsDistanceInWords(card.creationTime);
        cards.push(card);
      });
      app.ports.userCardsFetched.send(cards);
    });
  });

  app.ports.createCard.subscribe(function(card) {
    var updates = {};
    var cardId = dbCards.push().key;
    card.id = cardId;
    card.creationTime = +new Date();
    updates['/cards/' + cardId] = card;
    database.ref()
      .update(updates)
      .then(getCards)
      .catch(function(error) {
        console.error('## error during [pushing card]:', card, error);
      });
  });

  app.ports.fetchUser.subscribe(function(id) {
    database.ref('users/' + id).once('value', function(snapshot) {
      var userInDb = snapshot.val();

      if (userInDb) {
        app.ports.userFetched.send(userInDb);
      }
    });
  });

  /*
    port fetchUserTakenCards : String -> Cmd msg
  */
  app.ports.fetchUserTakenCards.subscribe(function(userId) {
    database.ref('user-taken-cards/' + userId).limitToLast(12).once('value', function(snapshot) {
      var cards = [];
      snapshot.forEach(function(card) {
        card = card.val();
        card.creationTimeFriendly = dateFnsDistanceInWords(card.creationTime);
        cards.push(card);
      });
      app.ports.userTakenCardsFetched.send(cards);
    });
  });

  /*
    port updateKarma : {authorId : String, cardId : String, karma : Int} -> Cmd msg
  */
  app.ports.updateKarma.subscribe(function(o) {
    var updates = {};
    updates['cards/' + o.cardId + '/karma'] = o.karma;
    database.ref()
      .update(updates)
      .then(function() {
        // karma updated
      })
      .catch(function(error) {
        console.error('## error during [updating karma]', o.karma, 'for card:', o.cardId, error);
      });
  });

  /*
    port takeCard : { user : User, card : Card } -> Cmd msg
  */
  app.ports.takeCard.subscribe(function(o) {
    var updates = {};
    updates['card-volunteers/' + o.card.id + '/' + o.user.uid] = o.user;
    updates['user-taken-cards/' + o.user.uid + '/' + o.card.id] = o.card;
    database.ref()
      .update(updates)
      .then(function() {
        console.info('## volunteer', o.user.uid, 'added to', o.card.id);
  
        database.ref('card-volunteers/' + o.card.id).once('value', function(snapshot) {
        var volunteers = [];
        snapshot.forEach(function(user) {
          volunteers.push(user.val());
        });
        app.ports.cardVolunteersFetched.send(volunteers);
      });
      })
      .catch(function(error) {
        console.error('## error during [adding volunteer]', o.user.uid, 'to card:', o.card.id, error);
      });
  });

  /*
    port removeCard : Card -> Cmd msg
  */
  app.ports.removeCard.subscribe(function(card) {
    database.ref('card-volunteers/' + card.id).once('value', function(snapshot) {
      var volunteers = [];
      snapshot.forEach(function(volunteer) {
        volunteers.push(volunteer.key());
      });

      var updates = {};
      updates['cards/' + card.id] = null;
      updates['card-volunteers/' + card.id] = null;
      volunteers.forEach(function(volunteerId) {
        updates['user-taken-cards/' + volunteerId + '/' + card.id] = null;
      });
      database.ref()
        .update(updates)
        .then(function() {
          // card removed
          app.ports.cardRemoved.send(card);
        })
        .catch(function(error) {
          console.error('## error during [removing card]:', card.id, error);
        });
    });
  });

  /*
    port assignVolunteer : { card: Card, user: User } -> Cmd msg
  */
  app.ports.assignVolunteer.subscribe(function(o) {
    var updates = {};
      database.ref('card-volunteers/' + o.card.id).once('value', function(snapshot) {
        var volunteers = [];
        snapshot.forEach(function(volunteer) {
          updates['user-taken-cards/' + volunteer.key + '/' + o.card.id + '/assignedTo'] = o.user.uid;
        });

        updates['cards/' + o.card.id + '/assignedTo'] = o.user.uid;

        database.ref()
          .update(updates)
          .then(function() {
            // volunteer accepted
          })
          .catch(function(error) {
            console.error('## error during [assigning volunteer]:', o.user.uid, 'for card:', o.card.id, error);
          });
      });
  });

  app.ports.persistCardText.subscribe(function(cardText) {
    if (!window.localStorage) return;
    localStorage.setItem('cardText', cardText);
  });

  if (window.localStorage) {
    var cardText = localStorage.getItem('cardText');
    if (cardText) {
      app.ports.cardTextFetched.send(cardText);
    }
  }
</script>
</html>